SELECT
    EST.NM_FANTASIA_ESTAB AS ESTAB,
    ROUND(
    AVG(
        CASE
            WHEN ROUND((P.DT_INTEGRACAO - Y.DT_LIBERACAO) * 24 * 60) BETWEEN 0 AND 3 THEN ROUND((P.DT_INTEGRACAO - Y.DT_LIBERACAO) * 24 * 60)
            WHEN ROUND((P.DT_INTEGRACAO - Y.DT_LIBERACAO) * 24 * 60) BETWEEN 4 AND 7 THEN ROUND((P.DT_INTEGRACAO - Y.DT_LIBERACAO) * 24 * 60)
            WHEN ROUND((P.DT_INTEGRACAO - Y.DT_LIBERACAO) * 24 * 60) BETWEEN 8 AND 20 THEN ROUND((P.DT_INTEGRACAO - Y.DT_LIBERACAO) * 24 * 60)
            WHEN ROUND((P.DT_INTEGRACAO - Y.DT_LIBERACAO) * 24 * 60) BETWEEN 21 AND 60 THEN ROUND((P.DT_INTEGRACAO - Y.DT_LIBERACAO) * 24 * 60)
            ELSE TRUNC((P.DT_INTEGRACAO - Y.DT_LIBERACAO) * 24)
        END
    ), 2
) AS AVG_TP_INTEGRA,
    COUNT(*) AS QNT_EXAMES
FROM
    PRESCR_MEDICA Y
    INNER JOIN PRESCR_PROCEDIMENTO P ON Y.NR_PRESCRICAO = P.NR_PRESCRICAO
    INNER JOIN PESSOA_FISICA PP ON Y.CD_PESSOA_FISICA = PP.CD_PESSOA_FISICA
    INNER JOIN EXAME_LABORATORIO EX ON P.NR_SEQ_EXAME = EX.NR_SEQ_EXAME
    INNER JOIN SETOR_ATENDIMENTO SS ON Y.CD_SETOR_ATENDIMENTO = SS.CD_SETOR_ATENDIMENTO
    LEFT JOIN SETOR_ATENDIMENTO SP ON P.CD_SETOR_ATENDIMENTO = SP.CD_SETOR_ATENDIMENTO
    LEFT JOIN USUARIO SUSP ON P.NM_USUARIO_SUSP = SUSP.NM_USUARIO
    INNER JOIN ATENDIMENTO_PACIENTE ATEND ON Y.NR_ATENDIMENTO = ATEND.NR_ATENDIMENTO
    INNER JOIN ESTABELECIMENTO EST ON Y.CD_ESTABELECIMENTO = EST.CD_ESTABELECIMENTO
    LEFT JOIN PROTOCOLO PR ON Y.CD_PROTOCOLO = PR.CD_PROTOCOLO
WHERE
    P.NR_SEQ_EXAME IN (SELECT NR_SEQ_EXAME FROM EXAME_LABORATORIO WHERE NR_SEQ_GRUPO = 360)
    AND Y.DT_LIBERACAO BETWEEN  SYSDATE -23/24 AND SYSDATE -0.25/24 -- PRESCRIÇÕES LIBERADAS NAS ÚLTIMAS 6 HORAS
    AND P.DT_INTEGRACAO IS NOT NULL
    AND P.DT_SUSPENSAO IS NULL
    --AND Y.CD_ESTABELECIMENTO NOT IN (105)
GROUP BY
    EST.NM_FANTASIA_ESTAB
ORDER BY
    AVG_TP_INTEGRA DESC;

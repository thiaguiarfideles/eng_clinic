SELECT 
  SUM(QNT_EXAMES) AS QNT_EXAMES,
  SUM(QNT_PRESCR) AS QNT_PRESCR,
   case when SUM(PERCENTUAL) < 1 then  TO_CHAR(SUM(PERCENTUAL), '0.00') || '%'
else TO_CHAR(SUM(PERCENTUAL), 'FM9999999990.00') || '%' end as PERCENTUAL,
  TEMPO_ESPERA,
  ESTABELECIMENTO
FROM (
  SELECT 
    COUNT(*) AS QNT_EXAMES,
    COUNT(DISTINCT y.NR_PRESCRICAO) QNT_PRESCR,
    (ROUND(RATIO_TO_REPORT(COUNT(*)) OVER() *100, 2))PERCENTUAL,
 -- ROUND(RATIO_TO_REPORT(COUNT(*)) OVER() *100, 2))PERCENTUAL,
CASE 
    WHEN ROUND((P.DT_INTEGRACAO - Y.DT_LIBERACAO) * 24 * 60) BETWEEN 0 AND 3 THEN ROUND((P.DT_INTEGRACAO - Y.DT_LIBERACAO) * 24 * 60) || ' MIN - NORMAL' 
    WHEN ROUND((P.DT_INTEGRACAO - Y.DT_LIBERACAO) * 24 * 60) BETWEEN 4 AND 7 THEN ROUND((P.DT_INTEGRACAO - Y.DT_LIBERACAO) * 24 * 60) || ' MIN - TEMPO_MÃ‰DIO' 
    WHEN ROUND((P.DT_INTEGRACAO - Y.DT_LIBERACAO) * 24 * 60) BETWEEN 8 AND 20 THEN ROUND((P.DT_INTEGRACAO - Y.DT_LIBERACAO) * 24 * 60) || ' MIN - TEMPO_LONGO' 
    WHEN ROUND((P.DT_INTEGRACAO - Y.DT_LIBERACAO) * 24 * 60) BETWEEN 21 AND 60 THEN ROUND((P.DT_INTEGRACAO - Y.DT_LIBERACAO) * 24 * 60) || ' MIN - TEMPO_MUITO_LONGO'
    ELSE TRUNC((P.DT_INTEGRACAO - Y.DT_LIBERACAO) * 24) || ' HORAS - TEMPO_MUITO_LONGO' 
END AS TEMPO_ESPERA,

    EST.NM_FANTASIA_ESTAB AS ESTABELECIMENTO
FROM PRESCR_MEDICA Y, PRESCR_PROCEDIMENTO P, PESSOA_FISICA PP, 
     EXAME_LABORATORIO EX, SETOR_ATENDIMENTO SS, MEDICO M, 
     USUARIO SUSP, SETOR_ATENDIMENTO SP, ATENDIMENTO_PACIENTE ATEND, ESTABELECIMENTO EST, PROTOCOLO PR
WHERE Y.NR_PRESCRICAO = P.NR_PRESCRICAO
AND   Y.CD_PESSOA_FISICA = PP.CD_PESSOA_FISICA 
AND   P.NR_SEQ_EXAME = EX.NR_SEQ_EXAME
AND   Y.CD_SETOR_ATENDIMENTO = SS.CD_SETOR_ATENDIMENTO
AND   P.CD_SETOR_ATENDIMENTO = SP.CD_SETOR_ATENDIMENTO(+)
AND   P.NM_USUARIO_SUSP = SUSP.NM_USUARIO(+)
AND   Y.CD_MEDICO = M.CD_PESSOA_FISICA(+)
AND   Y.NR_ATENDIMENTO = ATEND.NR_ATENDIMENTO
AND   Y.CD_ESTABELECIMENTO = EST.CD_ESTABELECIMENTO
AND   Y.CD_PROTOCOLO = PR.CD_PROTOCOLO(+)
AND   P.NR_SEQ_EXAME IN (SELECT NR_SEQ_EXAME FROM EXAME_LABORATORIO WHERE NR_SEQ_GRUPO IN (360))
--and   Y.DT_PRESCRICAO BETWEEN  SYSDATE -8/24 AND SYSDATE -0.25/24
and   y.DT_LIBERACAO  >= to_date('13/06/2023 06:00:01','dd/mm/yyyy HH24:MI:SS')
and   y.DT_LIBERACAO  <= to_date('20/06/2023 23:59:59','dd/mm/yyyy HH24:MI:SS')
AND   P.DT_INTEGRACAO IS not NULL 
AND   P.DT_SUSPENSAO IS NULL
AND   Y.cd_estabelecimento in (47,50)

GROUP BY
EST.NM_FANTASIA_ESTAB,Y.DT_LIBERACAO,P.DT_INTEGRACAO)
GROUP BY
  TEMPO_ESPERA,
  ESTABELECIMENTO
ORDER BY 1,5 asc
